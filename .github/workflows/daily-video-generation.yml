name: Video Generator - Daily Dual Content (Public Repo + Private Image)

on:
  # Daily dual content generation
  schedule:
    - cron: '0 10 * * *'    # Daily at 3:30 PM IST (10:00 AM UTC) - Videos ready by 5-6 AM EST
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      video_type:
        description: 'Type of video generation'
        required: true
        default: 'both'
        type: choice
        options:
          - 'main'
          - 'netflix'
          - 'both'
      enable_shorts:
        description: 'Enable shorts upload for main video'
        required: false
        default: false
        type: boolean
      enable_log_forwarding:
        description: 'Enable enhanced log capture and artifacts'
        required: false
        default: true
        type: boolean

env:
  DOCKER_IMAGE: video-creator:latest
  CONTAINER_NAME: video-generator-${{ github.run_id }}
  # Update this to your actual GHCR image path
  GHCR_IMAGE: ghcr.io/sathiyarajs/video-creator:latest

jobs:
  generate-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours to accommodate slow API responses
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Determine Video Settings
        id: settings
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Daily scheduled run - BOTH videos every day
            echo "enable_main_creation=true" >> $GITHUB_OUTPUT
            echo "enable_main_upload=true" >> $GITHUB_OUTPUT
            echo "enable_netflix_creation=true" >> $GITHUB_OUTPUT
            echo "enable_netflix_upload=true" >> $GITHUB_OUTPUT
            echo "enable_shorts=false" >> $GITHUB_OUTPUT
            echo "trigger_source=scheduled-daily-dual" >> $GITHUB_OUTPUT
            echo "video_type=both" >> $GITHUB_OUTPUT
            echo "enable_log_forwarding=true" >> $GITHUB_OUTPUT
            
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual run - use inputs
            case "${{ inputs.video_type }}" in
              "main")
                echo "enable_main_creation=true" >> $GITHUB_OUTPUT
                echo "enable_main_upload=true" >> $GITHUB_OUTPUT
                echo "enable_netflix_creation=false" >> $GITHUB_OUTPUT
                echo "enable_netflix_upload=false" >> $GITHUB_OUTPUT
                echo "video_type=main" >> $GITHUB_OUTPUT
                ;;
              "netflix")
                echo "enable_main_creation=false" >> $GITHUB_OUTPUT
                echo "enable_main_upload=false" >> $GITHUB_OUTPUT
                echo "enable_netflix_creation=true" >> $GITHUB_OUTPUT
                echo "enable_netflix_upload=true" >> $GITHUB_OUTPUT
                echo "video_type=netflix" >> $GITHUB_OUTPUT
                ;;
              "both")
                echo "enable_main_creation=true" >> $GITHUB_OUTPUT
                echo "enable_main_upload=true" >> $GITHUB_OUTPUT
                echo "enable_netflix_creation=true" >> $GITHUB_OUTPUT
                echo "enable_netflix_upload=true" >> $GITHUB_OUTPUT
                echo "video_type=both" >> $GITHUB_OUTPUT
                ;;
            esac
            echo "enable_shorts=${{ inputs.enable_shorts }}" >> $GITHUB_OUTPUT
            echo "trigger_source=manual" >> $GITHUB_OUTPUT
            echo "enable_log_forwarding=${{ inputs.enable_log_forwarding }}" >> $GITHUB_OUTPUT
            
          else
            # Default - both videos
            echo "enable_main_creation=true" >> $GITHUB_OUTPUT
            echo "enable_main_upload=true" >> $GITHUB_OUTPUT
            echo "enable_netflix_creation=true" >> $GITHUB_OUTPUT
            echo "enable_netflix_upload=true" >> $GITHUB_OUTPUT
            echo "enable_shorts=false" >> $GITHUB_OUTPUT
            echo "trigger_source=api" >> $GITHUB_OUTPUT
            echo "video_type=both" >> $GITHUB_OUTPUT
            echo "enable_log_forwarding=true" >> $GITHUB_OUTPUT
          fi
      
      # CRITICAL: Login to GHCR with Personal Access Token
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: sathiyarajs  # Your GitHub username
          password: ${{ secrets.GHCR_TOKEN }}  # Personal Access Token stored in secrets
      
      - name: Pull Private Docker Image from GHCR
        run: |
          echo "ðŸ“¦ Pulling private Docker image from GHCR..."
          echo "ðŸ” Using authenticated access to: ${{ env.GHCR_IMAGE }}"
          
          # Pull the private image
          docker pull ${{ env.GHCR_IMAGE }}
          
          # Tag it locally for easier reference
          docker tag ${{ env.GHCR_IMAGE }} ${{ env.DOCKER_IMAGE }}
          
          echo "âœ… Private image pulled and tagged successfully"
          
          # Verify image details
          echo "ðŸ“‹ Image details:"
          docker images ${{ env.DOCKER_IMAGE }}
      
      - name: Start Dual Video Generation Container
        run: |
          echo "ðŸš€ Starting dual video generation container from private GHCR image..."
          echo "ðŸ“Š Settings for ${{ steps.settings.outputs.trigger_source }}:"
          echo "  Video Type: ${{ steps.settings.outputs.video_type }}"
          echo "  Main Creation: ${{ steps.settings.outputs.enable_main_creation }}"
          echo "  Main Upload: ${{ steps.settings.outputs.enable_main_upload }}"
          echo "  Netflix Creation: ${{ steps.settings.outputs.enable_netflix_creation }}"
          echo "  Netflix Upload: ${{ steps.settings.outputs.enable_netflix_upload }}"
          echo "  Shorts Upload: ${{ steps.settings.outputs.enable_shorts }}"
          
          # Remove any existing container
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # Start container with dual video generation settings
          # The container's startup script will automatically trigger the webhook
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p 5678:5678 \
            --log-driver json-file \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            --log-opt labels=video-creator,workflow-run-${{ github.run_id }} \
            -e VIDEO_TYPE=${{ steps.settings.outputs.video_type }} \
            -e ENABLE_MAIN_CREATION=${{ steps.settings.outputs.enable_main_creation }} \
            -e ENABLE_MAIN_UPLOAD=${{ steps.settings.outputs.enable_main_upload }} \
            -e ENABLE_NETFLIX_CREATION=${{ steps.settings.outputs.enable_netflix_creation }} \
            -e ENABLE_NETFLIX_UPLOAD=${{ steps.settings.outputs.enable_netflix_upload }} \
            -e ENABLE_SHORTS_UPLOAD=${{ steps.settings.outputs.enable_shorts }} \
            -e ENABLE_TEASER_CREATION=${{ steps.settings.outputs.enable_shorts }} \
            -e TRIGGER_SOURCE=${{ steps.settings.outputs.trigger_source }} \
            -e SCHEDULE_TYPE=github-actions-dual \
            -e DAILY_DUAL_MODE=true \
            -e AUTO_TRIGGER_WEBHOOK=true \
            -e AZURE_TABLE_CONNECTION_STRING='${{ secrets.AZURE_TABLE_CONNECTION_STRING }}' \
            -e OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
            -e SERPAPI_KEY='${{ secrets.SERPAPI_KEY }}' \
            -e AMAZON_AFFILIATE_TAG='${{ secrets.AMAZON_AFFILIATE_TAG }}' \
            -e AZURE_TTS_KEY='${{ secrets.AZURE_TTS_KEY }}' \
            -e AZURE_TTS_REGION='${{ secrets.AZURE_TTS_REGION }}' \
            -e AZURE_TTS_VOICE='${{ secrets.AZURE_TTS_VOICE }}' \
            -e AZURE_STORAGE_ACCOUNT_NAME='${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}' \
            -e AZURE_STORAGE_ACCOUNT_KEY='${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}' \
            -e AZURE_STORAGE_CONTAINER_NAME='${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}' \
            -e N8N_ENCRYPTION_KEY='${{ secrets.N8N_ENCRYPTION_KEY }}' \
            ${{ env.DOCKER_IMAGE }}
          
          echo "âœ… Container started - webhook will be triggered automatically by startup script"
      
      # Stream logs in real-time to GitHub Actions
      - name: Stream Container Logs (Background)
        if: steps.settings.outputs.enable_log_forwarding == 'true'
        run: |
          echo "ðŸ“Š Starting log streaming..."
          
          # Stream logs to GitHub Actions output in background
          docker logs -f ${{ env.CONTAINER_NAME }} 2>&1 | while IFS= read -r line; do
            echo "[VIDEO-CREATOR] $line"
          done &
          
          LOG_PID=$!
          echo "LOG_PID=$LOG_PID" >> $GITHUB_ENV
          echo "âœ… Log streaming started (PID: $LOG_PID)"
      
      # Forward logs to BetterStack
      - name: Forward Logs to BetterStack (Background)
        if: steps.settings.outputs.enable_log_forwarding == 'true'
        env:
          BETTERSTACK_TOKEN: ${{ secrets.BETTERSTACK_SOURCE_TOKEN }}
        run: |
          echo "ðŸ“¤ Starting BetterStack log forwarding..."
          
          # Stream logs to BetterStack in background
          docker logs -f ${{ env.CONTAINER_NAME }} 2>&1 | while IFS= read -r line; do
            # Send each log line to BetterStack
            curl -s -X POST "https://in.logs.betterstack.com" \
              -H "Authorization: Bearer $BETTERSTACK_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"dt\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\",
                \"message\": \"$line\",
                \"level\": \"info\",
                \"container\": \"${{ env.CONTAINER_NAME }}\",
                \"workflow_run\": \"${{ github.run_id }}\",
                \"video_type\": \"${{ steps.settings.outputs.video_type }}\",
                \"source\": \"github-actions\"
              }" > /dev/null 2>&1
          done &
          
          BETTERSTACK_PID=$!
          echo "BETTERSTACK_PID=$BETTERSTACK_PID" >> $GITHUB_ENV
          echo "âœ… BetterStack forwarding started (PID: $BETTERSTACK_PID)"
      
      - name: Wait for Container Startup
        run: |
          echo "â³ Waiting for container startup and n8n initialization..."
          sleep 30
          
          # Check container status
          if ! docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "âŒ Container failed to start"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi
          
          echo "âœ… Container is running"
          echo ""
          echo "ðŸ“ Startup logs:"
          docker logs --tail 20 ${{ env.CONTAINER_NAME }} 2>/dev/null | grep -E "(n8n ready|Workflow|webhook)" || docker logs --tail 10 ${{ env.CONTAINER_NAME }}
      
      - name: Verify Auto-Triggered Dual Generation Setup
        run: |
          echo "ðŸ” Verifying auto-triggered dual generation setup..."
          docker exec ${{ env.CONTAINER_NAME }} sh -c '
            echo "=== Container Environment ==="
            echo "  VIDEO_TYPE: $VIDEO_TYPE"
            echo "  ENABLE_MAIN_CREATION: $ENABLE_MAIN_CREATION"
            echo "  ENABLE_MAIN_UPLOAD: $ENABLE_MAIN_UPLOAD"
            echo "  ENABLE_NETFLIX_CREATION: $ENABLE_NETFLIX_CREATION"
            echo "  ENABLE_NETFLIX_UPLOAD: $ENABLE_NETFLIX_UPLOAD"
            echo "  ENABLE_SHORTS_UPLOAD: $ENABLE_SHORTS_UPLOAD"
            echo "  DAILY_DUAL_MODE: $DAILY_DUAL_MODE"
            echo "  AUTO_TRIGGER_WEBHOOK: $AUTO_TRIGGER_WEBHOOK"
            echo "  TRIGGER_SOURCE: $TRIGGER_SOURCE"
            
            echo ""
            echo "=== Expected Auto-Generated Output ==="
            if [ "$ENABLE_MAIN_CREATION" = "true" ]; then
              echo "  ðŸ“¹ Main biographical video + metadata + thumbnail"
            fi
            if [ "$ENABLE_NETFLIX_CREATION" = "true" ]; then
              echo "  ðŸ“± Netflix-style habit short + metadata"
            fi
            
            echo ""
            echo "=== Startup Process Status ==="
            if [ -f "/app/startup.log" ]; then
              echo "  ðŸ“œ Startup log exists"
              tail -5 /app/startup.log 2>/dev/null || echo "  âš ï¸ Could not read startup log"
            else
              echo "  âš ï¸ No startup log found yet"
            fi
            
            echo ""
            echo "=== n8n Status ==="
            curl -f -s http://localhost:5678/healthz >/dev/null 2>&1 && echo "  âœ… n8n is responsive" || echo "  âŒ n8n not responding"
          '
      
      - name: Monitor Auto-Triggered Dual Video Generation
        run: |
          echo "ðŸ“Š Monitoring auto-triggered dual video generation..."
          echo "ðŸ¤– The container's startup script has automatically triggered the webhook"
          
          # Extended monitoring for dual generation (75 minutes)
          timeout_minutes=75
          check_interval=45
          max_checks=$((timeout_minutes * 60 / check_interval))
          
          main_completed=false
          netflix_completed=false
          
          for i in $(seq 1 $max_checks); do
            echo ""
            echo "ðŸ” Check $i/$max_checks ($(($i * $check_interval / 60)) min elapsed)"
            
            # Check current generation status
            status_info=$(docker exec ${{ env.CONTAINER_NAME }} sh -c '
              if [ -d "/app/target" ]; then
                echo "=== Target folder contents ==="
                ls -la /app/target/ 2>/dev/null || echo "Target folder empty"
                
                main_files=0
                netflix_files=0
                
                # Count main video files
                [ -f "/app/target/motivational_video.mp4" ] && main_files=$((main_files + 1))
                [ -f "/app/target/metadata.json" ] && main_files=$((main_files + 1))
                [ -f "/app/target/thumbnail.jpg" ] && main_files=$((main_files + 1))
                
                # Count Netflix files
                [ -f "/app/target/netflix_short.mp4" ] && netflix_files=$((netflix_files + 1))
                [ -f "/app/target/netflix_metadata.json" ] && netflix_files=$((netflix_files + 1))
                
                echo ""
                echo "=== File Status ==="
                echo "Main video files: $main_files/3 (video, metadata, thumbnail)"
                echo "Netflix files: $netflix_files/2 (video, metadata)"
                
                # Determine completion status
                main_complete="false"
                netflix_complete="false"
                
                [ $main_files -ge 3 ] && main_complete="true"  # At least core files
                [ $netflix_files -eq 2 ] && netflix_complete="true"
                
                echo "MAIN_COMPLETE:$main_complete"
                echo "NETFLIX_COMPLETE:$netflix_complete"
                
                # Overall status
                if [ "${{ steps.settings.outputs.video_type }}" = "both" ]; then
                  if [ "$main_complete" = "true" ] && [ "$netflix_complete" = "true" ]; then
                    echo "STATUS:COMPLETE"
                  elif [ "$main_complete" = "true" ] || [ "$netflix_complete" = "true" ]; then
                    echo "STATUS:PARTIAL"
                  else
                    echo "STATUS:IN_PROGRESS"
                  fi
                elif [ "${{ steps.settings.outputs.video_type }}" = "main" ]; then
                  [ "$main_complete" = "true" ] && echo "STATUS:COMPLETE" || echo "STATUS:IN_PROGRESS"
                elif [ "${{ steps.settings.outputs.video_type }}" = "netflix" ]; then
                  [ "$netflix_complete" = "true" ] && echo "STATUS:COMPLETE" || echo "STATUS:IN_PROGRESS"
                fi
              else
                echo "STATUS:STARTING"
              fi
            ')
            
            echo "$status_info"
            
            # Update completion flags
            if echo "$status_info" | grep -q "MAIN_COMPLETE:true"; then
              if [ "$main_completed" = "false" ]; then
                echo "âœ… Main video generation completed!"
                main_completed=true
              fi
            fi
            
            if echo "$status_info" | grep -q "NETFLIX_COMPLETE:true"; then
              if [ "$netflix_completed" = "false" ]; then
                echo "âœ… Netflix video generation completed!"
                netflix_completed=true
              fi
            fi
            
            # Check for overall completion
            if echo "$status_info" | grep -q "STATUS:COMPLETE"; then
              echo ""
              echo "ðŸŽ‰ All video generation completed successfully!"
              break
            fi
            
            # Show concise status
            echo ""
            echo "ðŸ“Š Video Generation Progress:"
            docker exec ${{ env.CONTAINER_NAME }} sh -c '
              main_count=0
              netflix_count=0
              [ -f "/app/target/motivational_video.mp4" ] && main_count=$((main_count + 1))
              [ -f "/app/target/metadata.json" ] && main_count=$((main_count + 1))
              [ -f "/app/target/thumbnail.jpg" ] && main_count=$((main_count + 1))
              [ -f "/app/target/netflix_short.mp4" ] && netflix_count=$((netflix_count + 1))
              [ -f "/app/target/netflix_metadata.json" ] && netflix_count=$((netflix_count + 1))
              
              echo "  Main Video: $main_count/3 files"
              echo "  Netflix Video: $netflix_count/2 files"
              
              if [ -f "/tmp/main_video_log.txt" ]; then
                last_log=$(tail -1 /tmp/main_video_log.txt 2>/dev/null | grep -oP "(?<=- INFO - ).*" || echo "Processing...")
                echo "  Status: $last_log"
              fi
            ' 2>/dev/null || echo "  Status: Starting..."
            
            sleep $check_interval
            
            if [ $i -eq $max_checks ]; then
              echo ""
              echo "âš ï¸ Video generation timed out after $timeout_minutes minutes"
              echo "ðŸ“‹ Final status:"
              echo "  Main video: $([ "$main_completed" = "true" ] && echo "âœ… Complete" || echo "âŒ Incomplete")"
              echo "  Netflix video: $([ "$netflix_completed" = "true" ] && echo "âœ… Complete" || echo "âŒ Incomplete")"
              echo ""
              echo "ðŸ“ Full container logs:"
              docker logs --tail 30 ${{ env.CONTAINER_NAME }}
              exit 1
            fi
          done
      
      - name: Final Verification
        run: |
          echo "ðŸ” Final verification of all generated content..."
          
          docker exec ${{ env.CONTAINER_NAME }} sh -c '
            cd /app/target 2>/dev/null || { echo "âŒ Target folder not found"; exit 1; }
            
            echo "ðŸ“ All generated files:"
            ls -lah
            
            echo ""
            echo "ðŸ“Š File details:"
            
            # Main video files
            if [ -f "motivational_video.mp4" ]; then
              size=$(stat -c%s "motivational_video.mp4" 2>/dev/null || stat -f%z "motivational_video.mp4")
              echo "âœ… Main video: $(($size / 1024 / 1024)) MB"
            else
              echo "âŒ Main video: Missing"
            fi
            
            if [ -f "thumbnail.jpg" ]; then
              size=$(stat -c%s "thumbnail.jpg" 2>/dev/null || stat -f%z "thumbnail.jpg")
              echo "âœ… Thumbnail: $(($size / 1024)) KB"
            else
              echo "âŒ Thumbnail: Missing"
            fi
            
            # Netflix video files
            if [ -f "netflix_short.mp4" ]; then
              size=$(stat -c%s "netflix_short.mp4" 2>/dev/null || stat -f%z "netflix_short.mp4")
              echo "âœ… Netflix video: $(($size / 1024 / 1024)) MB"
            else
              echo "âŒ Netflix video: Missing"
            fi
            
            # Metadata files
            if [ -f "metadata.json" ]; then
              echo "âœ… Main metadata: $(jq -r .youtube_title metadata.json 2>/dev/null || echo "Invalid JSON")"
            else
              echo "âŒ Main metadata: Missing"
            fi
            
            if [ -f "netflix_metadata.json" ]; then
              echo "âœ… Netflix metadata: $(jq -r .title netflix_metadata.json 2>/dev/null || echo "Invalid JSON")"
            else
              echo "âŒ Netflix metadata: Missing"
            fi
            
            echo ""
            echo "ðŸŽ¯ Daily content summary:"
            echo "  ðŸ“º Biographical content: $([ -f "motivational_video.mp4" ] && echo "âœ… Ready" || echo "âŒ Failed")"
            echo "  ðŸ“± Netflix-style content: $([ -f "netflix_short.mp4" ] && echo "âœ… Ready" || echo "âŒ Failed")"
          '
      
      # Export logs as artifact
      - name: Export Container Logs
        if: always() && steps.settings.outputs.enable_log_forwarding == 'true'
        run: |
          echo "ðŸ“¦ Exporting container logs..."
          mkdir -p logs
          docker logs ${{ env.CONTAINER_NAME }} > logs/container-${{ github.run_id }}.log 2>&1 || true
          
          # Also export internal log files if they exist
          docker cp ${{ env.CONTAINER_NAME }}:/tmp/main_video_log.txt logs/main_video.log 2>/dev/null || echo "No main video log"
          docker cp ${{ env.CONTAINER_NAME }}:/tmp/netflix_video_log.txt logs/netflix_video.log 2>/dev/null || echo "No netflix video log"
          
          echo "âœ… Logs exported to logs/ directory"
      
      # Upload logs as GitHub Actions artifact
      - name: Upload Logs as Artifact
        if: always() && steps.settings.outputs.enable_log_forwarding == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: video-generation-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
      
      - name: Cleanup Container
        if: always()
        run: |
          echo "ðŸ§¹ Final cleanup..."
          
          # Stop log streaming if running
          if [ -n "$LOG_PID" ]; then
            kill $LOG_PID 2>/dev/null || true
          fi
          
          # Stop BetterStack forwarding if running
          if [ -n "$BETTERSTACK_PID" ]; then
            kill $BETTERSTACK_PID 2>/dev/null || true
          fi
          
          echo "ðŸ“ Final container logs:"
          docker logs --tail 15 ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          echo "âœ… Cleanup completed"
